<!DOCTYPE html>
<html>

<head>
    <style>
        html,
        body {
            margin: 0px;
            width: 100%;
            height: 100%;
            background: #323232;
            font: 14px sans-serif;
            color: #dedede;
        }

        a {
            color: inherit;
            text-decoration: none !important;
        }

        img {
            max-width: 300px;
        }
    </style>

    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.100.0.min.js"></script>
</head>

<body>
    <h1>WEBP demo</h1>
    <p>
        <!-- <select id="url-options">
            <option value="screenshot">Screenshot</option>
            <option value="vr">VR</option>
        </select> -->

        <input type="number" id="image-id">
        <button id="go">Load</button>
    </p>
    <p id="status"></p>
    <div id="results">
        <div id="jpg">
            <h2>JPG</h2>
            <div id="jpg-large-container">
                <img id="jpg-large-img">
                <p id="jpg-large-text"></p>
            </div>

            <div id="jpg-preview-container">
                <img id="jpg-preview-img">
                <p id="jpg-preview-text"></p>
            </div>

            <div id="jpg-thumb-container">
                <img id="jpg-thumb-img">
                <p id="jpg-thumb-text"></p>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // var options = {
        //     screenshot: {
        //         large: 'https://d1g1aamoxberjq.cloudfront.net/webp/low_resolution_1517808076926_2_in.jpg',
        //         preview: 'https://d1g1aamoxberjq.cloudfront.net/webp/low_resolution_25_1517808076926_2_in.jpg',
        //         thumb: 'https://d1g1aamoxberjq.cloudfront.net/webp/thumbnail_1517808076926_2_in.jpg'
        //     }
        // }

        // function loadImage(data, key, type) {
        //     return new Promise((resolve) => {
        //         var now = new Date().getTime()
        //         var img = window.document.getElementById(type + '-' + key + '-img')
        //         var text = window.document.getElementById(type + '-' + key + '-text')

        //         img.onload = function () {
        //             text.textContent = 'Loaded ' + key + ' in ' + ((new Date().getTime() - now) / 1000).toFixed(2) + ' seconds'
        //             resolve()
        //         }

        //         img.src = data[key]
        //     })
        // }

        // function setImages(value) {
        //     loadImage(value, 'large', 'jpg')
        //         .then(() => {
        //             return loadImage(value, 'preview', 'jpg')
        //         })
        //         .then(() => {
        //             return loadImage(value, 'thumb', 'jpg')
        //         })
        // }

        // window.document.addEventListener("DOMContentLoaded", function () {
        //     var urlSelect = window.document.getElementById('url-options')

        //     urlSelect.addEventListener('change', function (e) {
        //         setImages(options[e.target.options[e.target.selectedIndex].value])
        //     })
        // })

        // setImages(options.screenshot)

        const region = `us-east-1`
        const delegationFn = `arn:aws:lambda:us-east-1:005536209483:function:swg-images-delegation`

        AWS.config.update({ region })
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({ IdentityPoolId: 'us-east-1:ff74f0a6-ee1c-4563-b5fa-b1d92c393f14' })

        const imageIdInput = window.document.getElementById(`image-id`)
        const goButton = window.document.getElementById(`go`)
        const jpgLargeImage = window.document.getElementById(`jpg-large-img`)
        const jpgLargeText = window.document.getElementById(`jpg-large-text`)
        const jpgPreviewImage = window.document.getElementById(`jpg-preview-img`)
        const jpgPreviewText = window.document.getElementById(`jpg-preview-text`)
        const jpgThumbImage = window.document.getElementById(`jpg-thumb-img`)
        const jpgThumbText = window.document.getElementById(`jpg-thumb-text`)
        const status = window.document.getElementById(`status`)

        goButton.addEventListener(`click`, (e)=>{
            var id = imageIdInput.value
            console.log(id)

            var xhr = new XMLHttpRequest()
            xhr.open(`GET`, `https://api.cklsylabs.com/swg/images/webp/process?id=${id}`)
            xhr.onload = (res)=>{
                let results

                try {
                    results = JSON.parse(xhr.responseText)
                    results = JSON.parse(results.Payload)
                } catch (error) {}

                console.log(results)

                if(!results || !results.original){
                    return
                }

                const lambda = new AWS.Lambda({ region })

                lambda.invoke({
                    FunctionName: delegationFn,
                    Payload: JSON.stringify({
                        imageUrl: results.original,
                        s3Path: id
                    }, null, 2)
                }, function (error, data) {
                    console.log(error, data)
                })
            }

            xhr.send()
        })

        // var xhr1 = new XMLHttpRequest()
        // xhr1.open(`GET`, `https://api.cklsylabs.com/swg/images/webp/convert?url=https://images.nvidia.com/swgf/146563624599552127/12979/U3Rhcl9XYXJzX19CYXR0bGVmcm9udF9JSV9fMjAxN19fU2NyZWVuc2hvdF8yMDE4LjA2LjA1X19fMjMuNDYuNTYuNzM.png`)
        // xhr1.setRequestHeader(`Accept`, `image/png`)
        // xhr1.setRequestHeader(`Content-type`, `image/png`)
        // xhr1.onload = (res) => {
        //     console.log(typeof xhr1.response)
        //     // var arrayBufferView = new Uint8Array(xhr1.response);
        //     var blob = new Blob([xhr1.response], { type: "image/png" });
        //     var urlCreator = window.URL || window.webkitURL;
        //     var imageUrl = urlCreator.createObjectURL(blob);
        //     var img = document.getElementById(`jpg-large-img`);
        //     img.src = imageUrl;
        // }

        // xhr1.send()

        // jpgLargeImage.src = `https://api.cklsylabs.com/swg/images/webp/convert?return_image=true&width=300&url=https://s3-us-west-2.amazonaws.com/cklsymedia/webp/2231/large.webp`

    </script>
</body>
<html>